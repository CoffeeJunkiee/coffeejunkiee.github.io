---
title:  "Hack The Box / Tally"
date: 2020-01-25
tags: [Penetration Testing, Hacking, Hack The Box, Jeeves, OSCP, Offensive Security]
header: 
  image: "assets/images/tally/tally-header.png"
---

Tally is our third machine in the OSCP list provided by [NetSec Focus](https://www.netsecfocus.com/)! This machine was a great learning experience where the solution problem and research skills were essential in order to root this machine. This is the third blog before my third attempt to the OSCP exam, so let's get to it!

<img src="{{ site.url }}{{ site.baseurl }}/assets/images/tally/list.jpg" alt="oscp list">

## Information Gathering

### Nmap Scan
So, we start with a nmap scan to check what ports are open and what services are running in this machine. 

```
nmap -sC -sV -p- -oN scan.nmap 10.10.10.59
```
<img src="{{ site.url }}{{ site.baseurl }}/assets/images/tally/nmap1.png" alt="nmap scan">
<img src="{{ site.url }}{{ site.baseurl }}/assets/images/tally/nmap2.png" alt="nmap scan">

So, we see some SMB, MSSQL and HTTP services running where all of them are going to be useful. The enumeration in this box is quite extense, but with some persistence and patiente, the clues are going to be coming out one at the time. I also tried to scan most of the HTTP services with not good result, but there was one that actually was useful that I'll explain later. 
After looking at the smb service running, I tried to do some scanning to see if I could find anything, but unf ortunately the result was not helpful.

<img src="{{ site.url }}{{ site.baseurl }}/assets/images/tally/nmap-smb.png" alt="nmap scan">

But after looking for more resources and things to look up in our nmap scan, there was a good __attack vector__ that was related with [Microsoft Sharepoint](https://support.office.com/en-us/article/what-is-sharepoint-97b915e6-651b-43b2-827d-fb25777f446f) running in port 32844. 

<img src="{{ site.url }}{{ site.baseurl }}/assets/images/tally/attack-vector.png" alt="nmap scan">

After looking how other people did this machine, there were a lot of ideas and tools. One of the tools was the [SharePountURLBrute](https://resources.bishopfox.com/resources/tools/sharepoint-hacking-diggity/attack-tools/) that was accurate in some results. This is the command in order to use the tool:
```
perl SharePointURLBrute.pl -a http://10.10.10.59 -e SharePoint-UrlExtensions-18Mar2012.txt
```
<img src="{{ site.url }}{{ site.baseurl }}/assets/images/tally/sharepoint-urlbrute.png" alt="nmap scan">

Although other people runned [gobuster]() to get some results, but in my case SharePountURLBrute gave more accurate results. In the case if you want to run gobuster, I strongly recommend to download [SecLists](https://github.com/danielmiessler/SecLists) in order to have good results. This is the command to run gobuster. 

```
gobuster dir -w /usr/share/seclists/Discovery/Web-Content/CMS/sharepoint.txt -u http://10.10.10.59/
```

After finding a couple URLs, the URl that gave useful information was ```http://10.10.10.59/shared%20documents/forms/allitems.aspx``` where there was some details about the ftp log in. 

<img src="{{ site.url }}{{ site.baseurl }}/assets/images/tally/ftp-documents.png" alt="nmap scan">

After downloading the file, we have the following information. 

<img src="{{ site.url }}{{ site.baseurl }}/assets/images/tally/ftp-credentials.png" alt="nmap scan">

Great! There is a password, but we don't have a username. It's time to look for more URLs in Microsoft Sharepoint. After trying more tools and not finding results, I tried to look on google things like ```"sharepoint site content url"``` where it came up with this useful [resource](https://docs.microsoft.com/en-us/archive/blogs/how24/famous-sharepoint-urls-locations). So, according to the site one of the URLs that contains information and content was ```http://10.10.10.59/_layouts/15/viewlsts.aspx``` where effectively there was something to look!

<img src="{{ site.url }}{{ site.baseurl }}/assets/images/tally/site-page.png" alt="nmap scan">

So after visiting ```http://10.10.10.59/SitePages/FinanceTeam.aspx``` There was a useful file from the Finance Team that contained useful information about the ftp_server. 

<img src="{{ site.url }}{{ site.baseurl }}/assets/images/tally/site-page-found.png" alt="nmap scan">

This is the information that is related with the ftp user account. 

<img src="{{ site.url }}{{ site.baseurl }}/assets/images/tally/ftp-user-account.png" alt="nmap scan">

Gratefully, we have username and password which means ```ftp_user:UTDRSCH53c"$6hys```

Then, after trying the credentials, log in was successsful.

<img src="{{ site.url }}{{ site.baseurl }}/assets/images/tally/ftp-logedin.png" alt="nmap scan">

Once we are in the ftp server there is a interesting file that we can find at ```\User\Tim\Files``` which is a KeePass file that will be helpful to look more credentials.

<img src="{{ site.url }}{{ site.baseurl }}/assets/images/tally/path-key-ftp.png" alt="nmap scan">

Once you find it and get it, you can crack it with [keepass2john](https://gist.github.com/HarmJ0y/116fa1b559372804877e604d7d367bbc) in order to obtain and extrack the hash with the following command.

```
keepass2john tim.kdbx > tim
```

After we have the hash from thh kdbx file, it's time to crack it wiht [John](https://www.openwall.com/john/)!
```
john -w=/usr/share/wordlists/rockyou.txt tim
```
<img src="{{ site.url }}{{ site.baseurl }}/assets/images/tally/john-cracked.png" alt="nmap scan">

Then it's time to get in with our credentials ```tim:simplementeyo```.

<img src="{{ site.url }}{{ site.baseurl }}/assets/images/tally/keepass.png" alt="nmap scan">

